
<!DOCTYPE html>
<html lang="en" class="no-js no-touch">
  <head>

    <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro">
    
<meta charset="utf-8" />


<title>
  
    Synchronizing with a web service
  
</title>





<meta name="author" content="https://plus.google.com/+KyawTun-Yathit/posts" />



<meta name="description" content="Synchronization using entity module" />


<link rel="icon" href="/favicon.ico" />

<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta id="viewport" name="viewport" content="width=device-width, initial-scale=1" />

<meta name="twitter:card" content="summary">
<meta property="twitter:account_id" content="@yathit" />
<meta property="twitter:site" content="@yathit" />
<meta property="twitter:description" content="Synchronization using entity module" />
<meta property="twitter:creator" content="@yathit" />
<meta property="twitter:image:src" content="/ydn-db/imgs/logo.png" />


<link rel="author" href="https://plus.google.com/+KyawTun-Yathit/posts">
<link rel="publisher" href="https://plus.google.com/+KyawTun-Yathit">

<meta itemprop="name" content="
  
    Synchronizing with a web service
  
">
<link itemprop="image" href="/imgs/logo.png">
<meta itemprop="description" content="Synchronization using entity module">

<meta property="og:site_name" content="Yathit" />
<meta property="og:title" content="
  
    Synchronizing with a web service
  
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/ydn-db/" />
<meta property="og:image" content="/ydn-db/imgs/logo.png" />

<link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/iccdnijlhdogaccaiafdpjmbakdcdakk">
<link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/ldikiokclnbceabnlbkabmcacpiednop">

<link rel="stylesheet" media="screen" href="/css/styles.min.css" />

<script src="/js/analytics.js"></script>

  </head>

  <body class="page-doc page--article article--ydndb-sync theme--ydndb-sync" itemscope itemtype="http://schema.org/TechArticle">
    

    <header class="main-header">

	























<nav class="main-nav">

  <header class="main-nav__header">
    <span class="main-nav__current-label">Synchronizing with a web service</span>
  </header>

  <ul class="main-nav__list clear">
  
    
    
    <li class="main-nav__item main-nav__item--<strong>ydn-db</strong>
                main-nav__item--home 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="/ydn-db/index.html" title="Go to <strong>YDN-DB</strong>">

        <strong>YDN-DB</strong>

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  
    
    
    <li class="main-nav__item main-nav__item--download
               
               
                 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="/ydn-db/downloads.html" title="Go to Download">

        Download

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  
    
    
    <li class="main-nav__item main-nav__item--documentation
               
               
                 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="/ydn-db/doc/index.html" title="Go to Documentation">

        Documentation

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  
    
    
    <li class="main-nav__item main-nav__item--api
               
               
                 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="/ydn-db/api/ydn/db/storage.html" title="Go to API">

        API

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  
    
    
    <li class="main-nav__item main-nav__item--examples
               
               
                 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="//dev.yathit.com/ydn-db/doc/example/index.html" title="Go to Examples">

        Examples

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  
    
    
    <li class="main-nav__item main-nav__item--github
               
               
                 
               
               
               ">
      <a class="main-nav__link main-nav__link--parent" href="https://github.com/yathit/ydn-db" title="Go to GitHub">

        GitHub

        
        <i class="main-nav__icon icon icon-chevron-right"></i>
        
      </a>

      

    </li>
    
  

  <li class="main-nav__item right">
    <a class="main-nav__link main-nav__link--parent" id="user-login">...</a>
  </li>
  <li class="main-nav__item right">
    <span class="main-nav__link main-nav__link--parent" id="user-name" style="display: none;"></span>
  </li>

  </ul>
  <button class="main-nav__btn btn--toggle-nav">
    <i class="icon icon-menu"></i>
  </button>

</nav>


</header>


    <div class="article-container" itemprop="text">

       <div class="ydn-breadcrumb-before"></div>
        <div class="container">
           <div class="content">
             <div id="ydn-breadcrumb" name="ydndb-doc"></div>
           </div>
        </div>
        <div class="ydn-breadcrumb-after"></div>

      <div class="editorial-header">
        <div class="container">
          <div class="content">

            <h1 class="editorial-header__title"></h1>
            <h2 class="editorial-header__subtitle" itemprop="name">Synchronizing with a web service</h2>

            <p class="editorial-header__excerpt" itemprop="headline">Automatically synchronize browser database with web service.</p>

          </div>
        </div>
      </div>


      <div class="container"><div class="content ">

    <p>Synchronizing client database and backend RESTful server is fairly straight forwards. However efficient synchronization requires detail consideration. To facilitate client side data caching, HTTP protocol provide two (four methods) request header. Basically the state of the data is identified by either etag or updated date or both. If etag is used, a GET request include <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> header of know etag value from the client side data. Server return 304 without response body if the data not changed. For modification requests, <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> header is used to prevent overriding wrong version of a resource. The use case of modified date is similar. </p>

    <p>Optionally, for updating whole object store (collections) efficient, last modified timestamp is used as sync checkpoint. The client will request last known modified timestamp from the database and send request to server of all records later then the timestamp. </p>

    <p>YDN-DB <code>entity</code> provide conditional update for resource, last modified timestamp base updating and <a href="http://en.wikipedia.org/wiki/Write-ahead_logging">write ahead logging</a> for offline write and restoring. However it is noted that YDN-DB only provide only necessary from client database. All these logic must implement in service provider, as describe below. </p>

    <p>The following example is base on <a href="http://yathit.github.io/ydndb-demo/entity-sync/app.html">entity sync demo app</a> and its full source code is available in <a href="https://github.com/yathit/ydndb-demo/tree/gh-pages/entity-sync">github</a>. <a href="https://parse.com">Parse</a> baas as used for backend service provider.</p>

    <p>The object store managed by entity sync service must use out-of-line key with key generator (<code>autoIncrement = true</code>). Internally the key is constructed as composite key of resource id and validator token. When these values are not available, auto generated key is used. </p>

    <p>An sync history object store is required for entity sync service for storing write-ahead-log records. The following schema is used in the example. Multiple entities can be used in a database.  </p>

    <pre><code>var schema = {
  stores: [{
    name: 'item',
    autoIncrement: true, // require by entity module, must not set keyPath.
    indexes: [{ // indexes are optional
      name: 'updatedAt',
      keyPath: 'updatedAt'
    }]
  }, {name: '_ydn_sync_history', // entity module requires this objectStore
    keyPath: 'sequence',
    autoIncrement: true,
    indexes: [
      {
        name: 'key',
        keyPath: ['entity', 'id']
      }
    ]
  }]
};
var db = new ydn.db.Storage('entity-sync-app', schema);   
</code></pre>

    <p>The entity object, which is used for consuming the CRUD operation is created by <code>entity</code> method to the <code>Storage</code> instance providing service provider.</p>

    <pre><code>var service = new ParseService('item', db);
var Item = db.entity(service, 'item');
</code></pre>

    <p>See <a href="https://github.com/yathit/ydndb-demo/blob/gh-pages/entity-sync/service.js">ParseService</a> for detail. Service and Entity are created by name, so that multiple entities can be used.</p>

    <p>Entity instance provide CRUD operations. All these operations will validate against with backend service. If backend service is not available, by returning 503 status code, the data are still updated to the database. In this case inconsistency are recorded in sync history object store. The application is responsible for resolving when backend is online. When backend and client database are in sync, there is no record in sync history object store.</p>

    <p>Entity record is retrieved by <code>get</code> in this following <code>showRecord</code> method. </p>

    <pre><code>var showRecord = function(id) {
  var df = Item.get(id);
  df.progress(function(obj) {
    renderRecord(obj);
  });
  df.then(function(obj) {
    renderRecord(obj);
  }, function(e) {
    console.error(e);
  });
};
</code></pre>

    <p>If record is already available in client database, it is provided in the <code>progress</code> method. The same object is invoked again in promise resolve callback if backend service return <code>304</code> (Not Modified). Otherwise updated record from the backend service is provided in the promise resolve callback. <code>showRecord</code> can use <code>==</code> operator for checking modified status of the object.</p>

    <p>To update whole object store, <code>update</code> method is used.  </p>

    <pre><code>var updateRecord = function() {
  message('updating...');
  Item.update().then(function(cnt) {
    message(cnt + ' records updated from server.');
    if (cnt) {
      showRecent();
    }
  }, function(e) {
    console.error(e);
  });
  showRecent();
};
</code></pre>

    <p><code>update</code> will invoke <code>list</code> method to service provider.  </p>

    <pre><code>RestService.prototype.list_ = function(cb, name, token) {
  Rest.list(function(arr) {
    var ids = arr.map(function(obj) {
      return obj.objectId;
    });
    var tokens = arr.map(function(obj) {
      return obj.updatedAt;
    });
    cb(200, arr, ids, tokens);
  }, token);
};


/**
 * @override
 */
RestService.prototype.list = function(cb, name, token) {
  if (token) {
    RestService.prototype.list_(cb, name, token);
  } else {
    this.db.values(this.name, 'updatedAt', null, 1, 0, true).always(function(obj) {
      var token = obj[0] ? obj[0].updatedAt : null;
      RestService.prototype.list_(cb, name, token);
    });
  }
};
</code></pre>

    <p>Since the serivce is using last modified data are incremental updating strategy, <code>list</code> method retrieve the last modified record from the client database using <code>updatedAt</code> index as described in above code snippet. It is noticed that YDN-DB entity module itself does not assume any updating strategy is used. Other updating stragegy such as incresing or descresing key can be used for immutable data in S3 service.    </p>

  </div></div>


      <div class="container clear-both">
        <div class="content">

          <div class="container-medium">
  <nav class="article-nav">
  
  
    <a class="article-nav-link article-nav-link--next" title="Next article" href="/ydn-db/doc/sync/build-in.html" style="float: right;">
      Next 'Synchronizing with AWS S3 like backend'
    </a>
  
  </nav>
</div>


          <br /><div class="g-comments" data-href=""></div>
        </div>
      </div>



      
        





      
      


<script src="/jsc/ydn.db-dev.js"></script>

    </div> <!-- /.article-container -->
    <div class="container clear">
	<div id="gc-content-license" class="gc-content-license g-wide--3 g-wide--last" >
		
		<div class="container clear">
	<div class="g-wide--3 g-wide--last">
    
		<h4>Authors</h4>
		
		
    <a href="/resources/contributors/index.html#kyawtun">
      Kyaw Tun</a>
		
    
	</div>
</div>

	</div>
</div>

    <footer class="main-footer">
  <div class="main-footer__container container clear">
    <div class="main-footer__list-group">
      <ul class="main-footer__list main-footer__list--primary">
      

        

        
        <li class="sitemap__item sitemap__item--<strong>ydn-db</strong>  sitemap__item--home  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="/ydn-db/index.html" title="Go to <strong>YDN-DB</strong>">
            <strong>YDN-DB</strong>
          </a>
        </li>
        
      

        

        
        <li class="sitemap__item sitemap__item--download  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="/ydn-db/downloads.html" title="Go to Download">
            Download
          </a>
        </li>
        
      

        

        
        <li class="sitemap__item sitemap__item--documentation  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="/ydn-db/doc/index.html" title="Go to Documentation">
            Documentation
          </a>
        </li>
        
      

        

        
        <li class="sitemap__item sitemap__item--api  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="/ydn-db/api/ydn/db/storage.html" title="Go to API">
            API
          </a>
        </li>
        
      

        

        
        <li class="sitemap__item sitemap__item--examples  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="//dev.yathit.com/ydn-db/doc/example/index.html" title="Go to Examples">
            Examples
          </a>
        </li>
        
      

        

        
        <li class="sitemap__item sitemap__item--github  ">
          <a class="sitemap-list__link sitemap-list__link--parent" href="https://github.com/yathit/ydn-db" title="Go to GitHub">
            GitHub
          </a>
        </li>
        
      
      </ul>

      <div class="main-footer__google-section">
        <h3 class="main-footer__title"><a href="/ydn-db/">
          <img id="developers-logo-footer" src="/imgs/yathit-dev-network.svg" alt="Yathit Developer Network logo">
        </a></h3>
        <ul class="main-footer__list main-footer__list--secondary google-list">
          <li><a href="https://www.yathit.com/">Yathit</a></li>
          <li><a href="https://www.yathit.com/terms.html">Terms of Service</a></li>
          <li><a href="https://www.yathit.com/privacy.html">Privacy Policy</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    <script src="/jsc/prettify.js"></script>

    
<script src="/js/script.js"></script>
<script src="/jsc/website-app.js"></script>
<script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>





  </body>
</html>

